name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: production-deployment
  cancel-in-progress: true


jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'source/package-lock.json'
      
      - name: Install dependencies
        working-directory: ./source
        run: npm install
      
      - name: Build application
        working-directory: ./source
        run: npm run build
      
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "âŒ Error: VPS_HOST secret is missing!"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_USERNAME }}" ]; then
            echo "âŒ Error: VPS_USERNAME secret is missing!"
            exit 1
          fi
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "âŒ Error: VPS_SSH_KEY secret is missing!"
            exit 1
          fi
          echo "âœ… All secrets are present"
      
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 300s
          debug: true
          script: |
            set -e  # Exit on any error
            set -x  # Debug mode - show all commands
            
            echo "ğŸš€ Starting deployment..."
            echo "ğŸ“‹ Environment check:"
            echo "  - Host: $(hostname)"
            echo "  - User: $(whoami)"
            echo "  - Date: $(date)"
            echo "  - Node version: $(node --version || echo 'Node.js not found')"
            echo "  - NPM version: $(npm --version || echo 'NPM not found')"
            echo "  - PM2 version: $(pm2 --version || echo 'PM2 not found')"
            
            # Check if project directory exists, if not clone it
            if [ ! -d "/var/www/websuli" ]; then
              echo "ğŸ“¦ Cloning repository..."
              mkdir -p /var/www
              cd /var/www
              git clone https://github.com/kosazoltan/WEBSULI.git websuli || {
                echo "âŒ Git clone failed!"
                exit 1
              }
            fi
            
            # Navigate to project source directory
            cd /var/www/websuli/source || {
              echo "âŒ Cannot access /var/www/websuli/source directory!"
              exit 1
            }
            
            echo "ğŸ“‚ Current directory: $(pwd)"
            echo "ğŸ“‹ Git status before pull:"
            git status --short || true
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main || {
              echo "âŒ Git fetch failed!"
              exit 1
            }
            git pull origin main || {
              echo "âš ï¸ Git pull had conflicts, attempting to reset..."
              git reset --hard origin/main || {
                echo "âŒ Git reset failed!"
                exit 1
              }
            }
            
            echo "ğŸ“‹ Git status after pull:"
            git log --oneline -3
            
            # Check Node.js and npm
            if ! command -v node &> /dev/null; then
              echo "âŒ Node.js is not installed!"
              exit 1
            fi
            
            if ! command -v npm &> /dev/null; then
              echo "âŒ NPM is not installed!"
              exit 1
            fi
            
            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm ci || npm install || {
              echo "âŒ npm install failed!"
              exit 1
            }
            
            # Clean previous build
            echo "ğŸ§¹ Cleaning previous build..."
            rm -rf dist || true
            rm -rf node_modules/.vite || true
            
            # Build the application
            echo "ğŸ”¨ Building application..."
            npm run build || {
              echo "âŒ Build failed!"
              echo "ğŸ“‹ Build error details:"
              cat package.json | grep -A 5 '"scripts"' || true
              exit 1
            }
            
            # Verify build output exists
            if [ ! -d "dist" ]; then
              echo "âŒ Build failed - dist directory not found!"
              exit 1
            fi
            
            if [ ! -d "dist/public" ]; then
              echo "âŒ Build failed - dist/public directory not found!"
              exit 1
            fi
            
            echo "âœ… Build completed successfully!"
            echo "ğŸ“‹ Build output:"
            ls -lah dist/public/ | head -10
            ls -lah dist/public/assets/ | head -10 || echo "âš ï¸ No assets directory found"
            
            # Run database migrations if needed
            echo "ğŸ—„ï¸ Running database migrations..."
            npm run db:push || {
              echo "âš ï¸ Database migration failed (non-critical, continuing...)"
            }
            
            # Force restart application with PM2
            echo "â™»ï¸ Restarting application with PM2..."
            
            # Stop existing process if running
            pm2 delete websuli 2>/dev/null || echo "No existing PM2 process found"
            sleep 2
            
            # Start application
            if [ ! -f "deploy/ecosystem.config.cjs" ]; then
              echo "âŒ PM2 ecosystem config not found at deploy/ecosystem.config.cjs!"
              exit 1
            fi
            
            pm2 start deploy/ecosystem.config.cjs --name websuli --update-env || {
              echo "âŒ PM2 start failed!"
              echo "ğŸ“‹ PM2 error log:"
              pm2 logs websuli --lines 20 --nostream || true
              exit 1
            }
            
            # Wait for app to start
            echo "â³ Waiting for application to start..."
            sleep 5
            
            # Check if app is running
            if pm2 list | grep -q "websuli.*online"; then
              echo "âœ… Application is running!"
              pm2 list
            else
              echo "âŒ Application failed to start!"
              echo "ğŸ“‹ PM2 status:"
              pm2 list
              echo "ğŸ“‹ PM2 logs (last 50 lines):"
              pm2 logs websuli --lines 50 --nostream || true
              exit 1
            fi
            
            # Save PM2 process list
            pm2 save || echo "âš ï¸ PM2 save failed (non-critical)"
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“‹ Final PM2 status:"
            pm2 list
            echo "ğŸŒ Application should be accessible now!"
      
      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment completed successfully!"
          else
            echo "âŒ Deployment failed!"
          fi
